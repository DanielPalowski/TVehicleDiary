@using VehicleDiary.Web.ViewModels
@model DBRepairVehicleModelVM

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card service-history-card shadow-sm mb-5">
                <div class="card-body p-4">
                    <h2 class="service-history-title mb-4">
                        <i class="fas fa-tools me-2 service-icon-blue"></i>Vehicle Service History
                    </h2>
                    <form asp-action="Create" method="post" id="repairForm">
                        <input type="hidden" asp-for="VehicleId" />

                        <!-- Display validation summary -->
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                        <div class="row g-3">
                            <!-- Category -->
                            <div class="col-md-6">
                                <label asp-for="RepairVCategory" class="form-label service-form-label">
                                    <i class="fas fa-list me-1 service-icon-blue"></i>Category
                                </label>
                                <select asp-for="RepairVCategory" class="form-control service-form-control" id="categorySelect" required>
                                    <option value="">Select Category</option>
                                    <option value="Vehicle Repairs">Vehicle Repairs</option>
                                    <option value="Vehicle Upgrades">Vehicle Upgrades</option>
                                    <option value="Diagnostics">Diagnostics</option>
                                </select>
                                <span asp-validation-for="RepairVCategory" class="text-danger small"></span>
                            </div>

                            <!-- Type -->
                            <div class="col-md-6">
                                <label asp-for="RepairVType" class="form-label service-form-label">
                                    <i class="fas fa-cog me-1 service-icon-blue"></i>Type
                                </label>
                                <select asp-for="RepairVType" class="form-control service-form-control" id="typeSelect" required disabled>
                                    <option value="">Select Type</option>
                                    <!-- Options will be populated dynamically -->
                                </select>
                                <span asp-validation-for="RepairVType" class="text-danger small"></span>
                            </div>

                            <!-- Name & Part -->
                            <div class="col-md-6">
                                <label asp-for="RepairVName" class="form-label service-form-label">
                                    <i class="fas fa-wrench me-1 service-icon-blue"></i>Service Name
                                </label>
                                <input type="text" asp-for="RepairVName" class="form-control service-form-control" placeholder="Oil Change" required>
                                <span asp-validation-for="RepairVName" class="text-danger small"></span>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="RepairVPart" class="form-label service-form-label">
                                    <i class="fas fa-cog me-1 service-icon-blue"></i>Part
                                </label>
                                <input type="text" asp-for="RepairVPart" class="form-control service-form-control" placeholder="Oil Filter">
                                <span asp-validation-for="RepairVPart" class="text-danger small"></span>
                            </div>

                            <!-- Date & Price -->
                            <div class="col-md-6">
                                <label asp-for="RepairVWhen" class="form-label service-form-label">
                                    <i class="fas fa-calendar me-1 service-icon-blue"></i>Date
                                </label>
                                <input type="date" asp-for="RepairVWhen" class="form-control service-form-control"
                                       value="@DateTime.Today.ToString("yyyy-MM-dd")" required>
                                <span asp-validation-for="RepairVWhen" class="text-danger small"></span>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="RepairVPrice" class="form-label service-form-label">
                                    <i class="fas fa-euro-sign me-1 service-icon-blue"></i>Price
                                </label>
                                <div class="input-group service-input-group">
                                    <span class="input-group-text">€</span>
                                    <input type="number" step="0.01" asp-for="RepairVPrice" class="form-control service-form-control" placeholder="120.50" required>
                                </div>
                                <span asp-validation-for="RepairVPrice" class="text-danger small"></span>
                            </div>

                            <!-- Technician & Notes -->
                            <div class="col-md-6">
                                <label asp-for="RepairVTechnician" class="form-label service-form-label">
                                    <i class="fas fa-user me-1 service-icon-blue"></i>Technician
                                </label>
                                <input type="text" asp-for="RepairVTechnician" class="form-control service-form-control" placeholder="John Doe">
                                <span asp-validation-for="RepairVTechnician" class="text-danger small"></span>
                            </div>

                            <div class="col-12">
                                <label asp-for="ReapairVNotes" class="form-label service-form-label">
                                    <i class="fas fa-sticky-note me-1 service-icon-blue"></i>Notes
                                </label>
                                <textarea asp-for="ReapairVNotes" class="form-control service-form-control service-textarea" rows="3" placeholder="Additional notes..."></textarea>
                                <span asp-validation-for="ReapairVNotes" class="text-danger small"></span>
                            </div>

                            <!-- Submit Button -->
                            <div class="col-12 mt-4">
                                <button class="btn btn-primary service-submit-btn w-100" type="submit" id="submitButton">
                                    <i class="fas fa-plus-circle me-2 service-icon-white"></i>Add Service Record
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    // Data structure mapping categories to types
    const categoryTypes = {
        "Vehicle Repairs": ["Engine", "Transmission", "Brakes", "Chassis", "Electrical", "Bodywork", "Air Conditioning"],
        "Vehicle Upgrades": ["Retrofit", "Performance", "Style", "Interior", "Accessories"],
        "Diagnostics": ["Coding", "Error Diagnostics", "Software Update"]
    };

    // Get DOM elements
    const categorySelect = document.getElementById('categorySelect');
    const typeSelect = document.getElementById('typeSelect');
    const repairForm = document.getElementById('repairForm');
    const submitButton = document.getElementById('submitButton');

    // Event listener for category change
    categorySelect.addEventListener('change', function() {
        const selectedCategory = this.value;

        // Reset and disable type select
        typeSelect.innerHTML = '<option value="">Select Type</option>';
        typeSelect.disabled = true;

        if (selectedCategory && categoryTypes[selectedCategory]) {
            // Add options for the selected category
            categoryTypes[selectedCategory].forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeSelect.appendChild(option);
            });

            // Enable type select
            typeSelect.disabled = false;
        }
    });

    // Form submission handler
    repairForm.addEventListener('submit', function(e) {
        // Basic validation
        if (!categorySelect.value || !typeSelect.value) {
            e.preventDefault();
            alert('Please select both a category and type');
            return;
        }

        // Show loading state
        submitButton.innerHTML = '<span class="service-loading"></span> Processing...';
        submitButton.disabled = true;
    });

    // Initialize the form based on any existing values
    document.addEventListener('DOMContentLoaded', function() {
        // If a category is already selected, trigger the change event
        if (categorySelect.value) {
            categorySelect.dispatchEvent(new Event('change'));

            // Set the type value if it exists
            if (typeSelect.querySelector(`option[value="${typeSelect.dataset.currentValue}"]`)) {
                typeSelect.value = typeSelect.dataset.currentValue;
            }
        }
    });
</script>